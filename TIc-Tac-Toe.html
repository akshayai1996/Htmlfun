<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Tic Tac Toe | Synth Edition</title>

<style>
:root {
    --bg: #0f172a;
    --card: #1e293b;
    --cell: #334155;
    --accent: #38bdf8;
    --text: #f8fafc;
    --win: #4ade80;
    --lose: #f87171;
}

* { box-sizing: border-box; user-select: none; -webkit-tap-highlight-color: transparent; }

body {
    margin: 0; background: var(--bg); font-family: 'Segoe UI', sans-serif;
    color: var(--text); display: flex; justify-content: center; align-items: center;
    min-height: 100vh; overflow: hidden;
}

#app {
    width: min(92vw, 400px); background: var(--card); padding: 24px;
    border-radius: 24px; box-shadow: 0 20px 50px -12px rgba(0,0,0,0.5);
    border: 1px solid rgba(255,255,255,0.1);
}

h2 {
    text-align: center; margin: 0 0 24px 0; font-weight: 800; font-size: 1.8rem;
    background: linear-gradient(to right, #38bdf8, #818cf8);
    -webkit-background-clip: text; -webkit-text-fill-color: transparent;
}

.section { margin-bottom: 20px; }
.label-title { font-size: 0.75rem; text-transform: uppercase; letter-spacing: 1.5px; color: #94a3b8; margin-bottom: 10px; display: block; font-weight: 700; }

.options { display: flex; background: rgba(0,0,0,0.3); padding: 4px; border-radius: 12px; gap: 4px; }
.options label { flex: 1; cursor: pointer; position: relative; z-index: 1; }
.options input { display: none; }
.options span { display: flex; justify-content: center; align-items: center; padding: 10px; border-radius: 8px; font-weight: 600; font-size: 0.9rem; transition: all 0.2s ease; color: #cbd5e1; }
.options input:checked + span { background: var(--accent); color: #0f172a; box-shadow: 0 4px 12px rgba(56,189,248,0.3); }

button { font-family: inherit; border: none; cursor: pointer; transition: transform 0.1s; }
button:active { transform: scale(0.96); }

.primary-btn { width: 100%; padding: 16px; font-size: 1.1rem; border-radius: 14px; background: var(--accent); color: #0f172a; font-weight: 800; margin-top: 8px; box-shadow: 0 4px 0 #0ea5e9; }
.primary-btn:active { box-shadow: 0 0 0 #0ea5e9; transform: translateY(4px); }

#musicBtn { margin-top: 16px; background: transparent; border: 2px solid rgba(255,255,255,0.1); color: #94a3b8; padding: 12px; border-radius: 12px; font-size: 0.9rem; font-weight: 600; width: 100%; }

#board { display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 20px 0; }
.cell { aspect-ratio: 1; background: var(--cell); border-radius: 16px; font-size: clamp(40px, 15vw, 64px); font-weight: 900; color: var(--accent); display: flex; align-items: center; justify-content: center; box-shadow: 0 6px 0 rgba(0,0,0,0.3); transition: background 0.2s; }
.cell.taken { background: #1e293b; box-shadow: inset 0 4px 8px rgba(0,0,0,0.4); cursor: default; }
.cell.win { background: var(--win); color: #064e3b; animation: pop 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275); }
@keyframes pop { 0% { transform: scale(0.8); } 100% { transform: scale(1); } }

.hidden { display: none !important; }
#status { text-align: center; font-size: 1.2rem; font-weight: 700; min-height: 1.5em; color: #e2e8f0; }
.disabled-board { pointer-events: none; opacity: 0.8; }
.confetti { position: fixed; top: -10px; z-index: 9999; animation: fall linear forwards; }
@keyframes fall { to { transform: translateY(110vh) rotate(720deg); } }
</style>
</head>
<body>

<div id="app">
    <div id="settings">
        <h2>Tic Tac Toe</h2>
        <div class="section">
            <span class="label-title">Side</span>
            <div class="options">
                <label><input type="radio" name="marker" value="X" checked><span>X</span></label>
                <label><input type="radio" name="marker" value="O"><span>O</span></label>
            </div>
        </div>
        <div class="section">
            <span class="label-title">Difficulty</span>
            <div class="options">
                <label><input type="radio" name="difficulty" value="easy" checked><span>Easy</span></label>
                <label><input type="radio" name="difficulty" value="medium"><span>Med</span></label>
                <label><input type="radio" name="difficulty" value="hard"><span>Hard</span></label>
            </div>
        </div>
        <button class="primary-btn" onclick="startGame()">Start Game</button>
        <button id="musicBtn" onclick="toggleMusic()">ðŸ”Š Sound: ON</button>
    </div>

    <div id="game" class="hidden">
        <div id="status">Your Turn</div>
        <div id="board"></div>
        <button class="primary-btn" style="background:#475569; box-shadow:0 4px 0 #334155" onclick="resetGame()">Restart</button>
    </div>
</div>

<script>
/* ================================================================
   THE SYNTHESIZER ENGINE (Web Audio API)
   Generates sound mathematically. No files. No blocking. 
   ================================================================
*/
const AudioContext = window.AudioContext || window.webkitAudioContext;
let audioCtx;
let musicInterval = null;
let soundEnabled = true;

// Initialize Audio Context (Must be done on user gesture)
function initAudio() {
    if (!audioCtx) audioCtx = new AudioContext();
    if (audioCtx.state === 'suspended') audioCtx.resume();
}

// Basic Tone Generator
function playTone(freq, type, duration, vol = 0.1) {
    if (!audioCtx || !soundEnabled) return;
    const osc = audioCtx.createOscillator();
    const gain = audioCtx.createGain();
    
    osc.type = type;
    osc.frequency.setValueAtTime(freq, audioCtx.currentTime);
    
    gain.gain.setValueAtTime(vol, audioCtx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + duration);

    osc.connect(gain);
    gain.connect(audioCtx.destination);
    
    osc.start();
    osc.stop(audioCtx.currentTime + duration);
}

// Sound Effects
const SFX = {
    tap: () => playTone(600, 'sine', 0.1, 0.1),
    win: () => {
        // Play a major triad (C E G)
        setTimeout(() => playTone(523.25, 'triangle', 0.3, 0.2), 0);
        setTimeout(() => playTone(659.25, 'triangle', 0.3, 0.2), 100);
        setTimeout(() => playTone(783.99, 'triangle', 0.6, 0.2), 200);
    },
    lose: () => {
        // Play a descending low tone
        playTone(150, 'sawtooth', 0.4, 0.15);
        setTimeout(() => playTone(100, 'sawtooth', 0.4, 0.15), 200);
    }
};

// Procedural Music (Arpeggiator)
function startMusic() {
    if (musicInterval) clearInterval(musicInterval);
    if (!soundEnabled) return;
    
    // Simple C Major pentatonic pattern
    const notes = [261.63, 329.63, 392.00, 523.25]; 
    let step = 0;

    musicInterval = setInterval(() => {
        if (!soundEnabled || document.hidden) return;
        // Play very soft background notes
        let freq = notes[step % notes.length];
        // Add variation
        if (Math.random() > 0.8) freq *= 0.5; 
        
        playTone(freq, 'sine', 0.5, 0.03); // Very quiet volume (0.03)
        step++;
    }, 400); // 150 BPM approx
}

function stopMusic() {
    if (musicInterval) clearInterval(musicInterval);
}

function toggleMusic() {
    initAudio();
    soundEnabled = !soundEnabled;
    const btn = document.getElementById("musicBtn");
    btn.innerText = soundEnabled ? "ðŸ”Š Sound: ON" : "ðŸ”‡ Sound: OFF";
    
    if (soundEnabled) {
        // Only start music if in game
        if (!document.getElementById("game").classList.contains("hidden")) {
            startMusic();
        }
    } else {
        stopMusic();
    }
}

/* ================================================================
   GAME LOGIC
   ================================================================
*/
const WIN_COMBOS = [[0,1,2],[3,4,5],[6,7,8],[0,3,6],[1,4,7],[2,5,8],[0,4,8],[2,4,6]];
let board = [], player = "X", computer = "O", turn = "X", difficulty = "easy", gameOver = false;
let computerTimer = null;

function startGame() {
    initAudio(); // Wake up audio engine
    player = document.querySelector('input[name="marker"]:checked').value;
    computer = player === "X" ? "O" : "X";
    difficulty = document.querySelector('input[name="difficulty"]:checked').value;

    board = Array(9).fill(null);
    gameOver = false;
    clearTimeout(computerTimer);

    document.getElementById("settings").classList.add("hidden");
    document.getElementById("game").classList.remove("hidden");
    
    renderBoard();
    updateStatus();
    
    if(soundEnabled) startMusic();

    // Player always goes first in this simplified UI flow, unless we add toggle.
    // Assuming Player starts for simplicity, but if you want Computer start logic:
    // (Added "Who Starts" logic hidden default to Player for cleaner UI, or use coin flip)
    turn = player; 
}

function renderBoard() {
    const boardEl = document.getElementById("board");
    boardEl.innerHTML = "";
    boardEl.className = (turn === computer || gameOver) ? "disabled-board" : "";

    board.forEach((cell, i) => {
        const btn = document.createElement("button");
        btn.className = `cell ${cell ? 'taken' : ''}`;
        btn.innerText = cell || "";
        btn.onclick = () => playerMove(i);
        boardEl.appendChild(btn);
    });
}

function playerMove(i) {
    if (gameOver || board[i] || turn !== player) return;
    SFX.tap();
    makeMove(i, player);
    
    if (!checkEnd(player)) {
        turn = computer;
        renderBoard();
        updateStatus();
        computerTimer = setTimeout(computerMove, 600 + Math.random()*300);
    }
}

function computerMove() {
    if (gameOver) return;
    let idx;
    
    // AI LOGIC
    if (difficulty === "easy") idx = getWorstMove(); // Tries to lose
    else if (difficulty === "medium") idx = Math.random() < 0.4 ? getRandomMove() : getBestMove();
    else idx = getBestMove();

    SFX.tap();
    makeMove(idx, computer);

    if (!checkEnd(computer)) {
        turn = player;
        renderBoard();
        updateStatus();
    }
}

function makeMove(i, who) {
    board[i] = who;
    renderBoard();
}

function checkEnd(lastPlayer) {
    const combo = WIN_COMBOS.find(c => c.every(i => board[i] === lastPlayer));
    if (combo) {
        gameOver = true;
        const won = lastPlayer === player;
        document.getElementById("status").innerText = won ? "You Win! ðŸŽ‰" : "Computer Wins ðŸ¤–";
        
        combo.forEach(i => document.getElementsByClassName("cell")[i].classList.add("win"));
        document.getElementById("board").classList.remove("disabled-board");
        
        stopMusic(); // Stop BG music on end
        won ? SFX.win() : SFX.lose();
        if(won) launchConfetti();
        return true;
    }
    if (board.every(c => c !== null)) {
        gameOver = true;
        document.getElementById("status").innerText = "Draw ðŸ˜";
        document.getElementById("board").classList.remove("disabled-board");
        stopMusic();
        return true;
    }
    return false;
}

function updateStatus() {
    if (!gameOver) document.getElementById("status").innerText = turn === player ? "Your Turn" : "Computer Thinking...";
}

function resetGame() {
    clearTimeout(computerTimer);
    stopMusic();
    document.getElementById("settings").classList.remove("hidden");
    document.getElementById("game").classList.add("hidden");
}

/* AI HELPERS */
function getRandomMove() {
    const empty = board.map((v,i)=>v?null:i).filter(v=>v!==null);
    return empty[Math.floor(Math.random()*empty.length)];
}
function getWorstMove() {
    // Looks for a move that gives the player a win next turn
    let empty = board.map((v,i)=>v?null:i).filter(v=>v!==null);
    if(empty.length > 7) return getRandomMove();
    for(let i of empty) {
        board[i] = computer;
        let score = minimax(board,0,false);
        board[i] = null;
        if(score < -5) return i; // This move leads to player win
    }
    return getRandomMove();
}
function getBestMove() {
    let best = -Infinity, move = -1;
    let empty = board.map((v,i)=>v?null:i).filter(v=>v!==null);
    if(empty.length===9) return 4;
    for(let i of empty) {
        board[i] = computer;
        let score = minimax(board,0,false);
        board[i] = null;
        if(score > best) { best = score; move = i; }
    }
    return move;
}
function minimax(bd, d, max) {
    if (WIN_COMBOS.some(c => c.every(i => bd[i] === computer))) return 10-d;
    if (WIN_COMBOS.some(c => c.every(i => bd[i] === player))) return d-10;
    if (bd.every(c => c)) return 0;
    
    let empty = bd.map((v,i)=>v?null:i).filter(v=>v!==null);
    let best = max ? -Infinity : Infinity;
    for (let i of empty) {
        bd[i] = max ? computer : player;
        let s = minimax(bd, d+1, !max);
        bd[i] = null;
        best = max ? Math.max(best, s) : Math.min(best, s);
    }
    return best;
}

/* CONFETTI */
function launchConfetti() {
    const colors = ['#38bdf8', '#4ade80', '#f472b6'];
    for (let i=0; i<100; i++) {
        const c = document.createElement("div");
        c.className = "confetti";
        c.style.left = Math.random()*100+"vw";
        c.style.background = colors[Math.floor(Math.random()*colors.length)];
        c.style.width = Math.random()*8+4+"px";
        c.style.height = c.style.width;
        c.style.animationDuration = Math.random()*2+2+"s";
        document.body.appendChild(c);
        setTimeout(()=>c.remove(), 4000);
    }
}
</script>
</body>
</html>
